<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.Title}}</title>
    <meta name="description" content="{{if .Description}}{{.Description}}{{else}}Chat with OpenBot — self-hosted AI assistant.{{end}}">
    <meta property="og:title" content="{{.Title}}">
    <meta property="og:description" content="{{if .Description}}{{.Description}}{{else}}Chat with OpenBot — self-hosted AI assistant.{{end}}">
    <script src="/assets/tailwind.js"></script>
    <script>tailwind.config={darkMode:'class'}</script>
    <link rel="stylesheet" href="/assets/openbot-tokens.css">
    <script src="/assets/marked.min.js"></script>
    <link rel="stylesheet" href="/assets/github-dark.min.css">
    <script src="/assets/highlight.min.js"></script>
    <style>
        #chat-messages { scroll-behavior: smooth; }
        @keyframes pulse-dot { 0%, 80%, 100% { opacity: 0.3; } 40% { opacity: 1; } }
        .thinking-dot { animation: pulse-dot 1.4s infinite ease-in-out both; }
        .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
        .msg-user { animation: slideIn 0.2s ease-out; }
        .msg-bot { animation: fadeIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .prose pre { background: var(--ob-code-bg-dark); color: var(--ob-code-text); border-radius: var(--ob-radius-md); padding: var(--ob-space-4); overflow-x: auto; }
        .prose code { background: var(--ob-code-bg); padding: 0.125rem 0.375rem; border-radius: var(--ob-radius-sm); font-size: 0.875rem; }
        .dark .prose code { background: var(--ob-code-inline-dark); color: var(--ob-code-inline-text); }
        .prose pre code { background: none; padding: 0; }
        .tool-badge { display: inline-flex; align-items: center; gap: var(--ob-space-1); padding: 2px 8px; border-radius: var(--ob-radius-full); font-size: 0.75rem; font-weight: 500; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .tool-spinner { animation: spin 1s linear infinite; width: 12px; height: 12px; border: 2px solid var(--ob-spinner-border); border-top-color: var(--ob-spinner-top); border-radius: 50%; }
        textarea { transition: height 0.1s ease; }
        .sidebar-item { transition: background 0.15s; }
        .sidebar-item:hover { background: var(--ob-sidebar-hover); }
        .sidebar-item.active { background: var(--ob-sidebar-active); border-right: 3px solid var(--ob-primary); }
        #sidebar { transition: transform 0.25s ease; }
        @media (max-width: 768px) {
            #sidebar { transform: translateX(-100%); position: fixed; z-index: 40; height: 100%; }
            #sidebar.open { transform: translateX(0); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 h-full flex flex-col">
    <!-- Navbar -->
    <nav class="bg-white dark:bg-gray-800 shadow-sm border-b dark:border-gray-700 z-30 relative">
        <div class="max-w-full mx-auto px-4 py-3 flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <button onclick="toggleSidebar()" class="md:hidden text-gray-600 dark:text-gray-300 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <img src="/assets/logo.png" alt="OpenBot" class="w-8 h-8 rounded-lg"/>
                <a href="/" class="font-bold text-xl text-gray-800 dark:text-white hover:text-blue-600">OpenBot</a>
            </div>
            <div class="flex items-center space-x-4">
                <a href="/" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium hidden sm:inline">Dashboard</a>
                <a href="/chat" class="text-blue-600 dark:text-blue-400 font-medium">Chat</a>
                <a href="/settings" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium hidden sm:inline">Settings</a>
                <button onclick="toggleDarkMode()" class="p-2 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-700 transition" title="Toggle dark mode">
                    <span id="theme-icon" class="text-lg">&#x1F319;</span>
                </button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden">
        <!-- Sidebar -->
        <aside id="sidebar" class="w-72 bg-white dark:bg-gray-800 border-r dark:border-gray-700 flex flex-col">
            <div class="p-3 border-b dark:border-gray-700">
                <button onclick="newConversation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    New Chat
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-2" id="conversation-list">
                <p class="text-xs text-gray-400 dark:text-gray-500 p-2">Loading conversations...</p>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="flex-1 flex flex-col overflow-hidden">
            <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-3 min-h-[12rem]" style="contain: layout;">
                <div id="welcome-msg" class="text-center text-gray-400 dark:text-gray-500 py-16">
                    <p class="text-2xl mb-2">&#x1F44B;</p>
                    <p class="text-lg mb-1 text-gray-600 dark:text-gray-300">Hello! I'm OpenBot.</p>
                    <p class="text-sm">Type a message below to start chatting.</p>
                </div>
            </div>

            <form id="chat-form" class="bg-white dark:bg-gray-800 border-t dark:border-gray-700 p-3" onsubmit="return handleSend(event)">
                <div class="max-w-4xl mx-auto flex items-end space-x-3">
                    <input type="file" id="file-input" name="files" multiple accept=".txt,.json,.csv,.md,.log,text/*,application/json,application/csv,application/pdf,image/jpeg,image/png,image/gif,image/webp" class="hidden" title="Attach files">
                    <button type="button" id="attach-btn" class="p-2 rounded-lg text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-600 transition flex-shrink-0" title="Attach files" onclick="document.getElementById('file-input').click()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/></svg>
                    </button>
                    <textarea
                        name="message"
                        id="message-input"
                        rows="1"
                        placeholder="Type your message... (Shift+Enter for newline)"
                        class="flex-1 resize-none border dark:border-gray-600 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-gray-800 dark:text-gray-200 bg-white dark:bg-gray-700"
                        class="ob-input-chat"
                        oninput="autoResize(this)"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button
                        type="submit"
                        id="send-btn"
                        class="bg-blue-600 text-white px-5 py-2 rounded-lg hover:bg-blue-700 transition font-medium disabled:opacity-50 disabled:cursor-not-allowed"
                    >Send</button>
                </div>
                <div id="file-list" class="max-w-4xl mx-auto mt-1 text-xs text-gray-500 dark:text-gray-400 hidden"></div>
            </form>
        </main>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebar-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-30 md:hidden" onclick="toggleSidebar()"></div>

    <script>
    const chatMessages = document.getElementById('chat-messages');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');

    let chatState = 'idle';
    let currentBotDiv = null;
    let accumulatedContent = '';
    let activeTools = new Map();
    let eventSource = null;
    let lastUserMessageForRetry = '';

    // --- Dark mode ---
    function initTheme() {
        const saved = localStorage.getItem('openbot-theme');
        if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
            document.getElementById('theme-icon').textContent = '\u2600\uFE0F';
        }
    }
    function toggleDarkMode() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('openbot-theme', isDark ? 'dark' : 'light');
        document.getElementById('theme-icon').textContent = isDark ? '\u2600\uFE0F' : '\uD83C\uDF19';
    }
    initTheme();

    // --- Sidebar ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebar-overlay').classList.toggle('hidden');
    }

    async function loadConversations() {
        try {
            const resp = await fetch('/api/conversations');
            if (!resp.ok) return;
            const convs = await resp.json();
            renderConversationList(convs || []);
        } catch(e) {}
    }

    function renderConversationList(convs) {
        const list = document.getElementById('conversation-list');
        if (!convs.length) {
            list.innerHTML = '<div class="p-4 text-center text-gray-500 dark:text-gray-400"><p class="text-sm mb-2">No conversations yet.</p><p class="text-xs">Click <strong>New Chat</strong> above to start.</p></div>';
            return;
        }

        // Group by date
        const today = new Date(); today.setHours(0,0,0,0);
        const yesterday = new Date(today); yesterday.setDate(yesterday.getDate()-1);
        const week = new Date(today); week.setDate(week.getDate()-7);

        const groups = { 'Today': [], 'Yesterday': [], 'Last 7 days': [], 'Older': [] };
        for (const c of convs) {
            const d = new Date(c.updated_at); d.setHours(0,0,0,0);
            if (d >= today) groups['Today'].push(c);
            else if (d >= yesterday) groups['Yesterday'].push(c);
            else if (d >= week) groups['Last 7 days'].push(c);
            else groups['Older'].push(c);
        }

        let html = '';
        for (const [label, items] of Object.entries(groups)) {
            if (!items.length) continue;
            html += `<div class="text-xs font-semibold text-gray-400 dark:text-gray-500 px-2 pt-3 pb-1">${label}</div>`;
            for (const c of items) {
                const title = c.title || 'Untitled';
                html += `<div class="sidebar-item rounded-lg px-3 py-2 cursor-pointer text-sm text-gray-700 dark:text-gray-300 truncate flex items-center justify-between group"
                    onclick="loadConversation('${c.id}')">
                    <span class="truncate">${escapeHtml(title)}</span>
                    <button onclick="event.stopPropagation(); deleteConversation('${c.id}')"
                        class="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition p-0.5" title="Delete">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                    </button>
                </div>`;
            }
        }
        list.innerHTML = html;
    }

    async function loadConversation(id) {
        try {
            const resp = await fetch(`/api/conversations/${id}/messages`);
            if (!resp.ok) return;
            const msgs = await resp.json();
            chatMessages.innerHTML = '';
            if (!msgs || !msgs.length) {
                chatMessages.innerHTML = '<div id="welcome-msg" class="text-center text-gray-400 dark:text-gray-500 py-16"><p>No messages in this conversation.</p></div>';
                return;
            }
            for (const m of msgs) {
                if (m.role === 'user') addUserMessage(m.content);
                else if (m.role === 'assistant' && m.content) addBotMessage(m.content);
            }
        } catch(e) {}
    }

    async function deleteConversation(id) {
        if (!confirm('Delete this conversation?')) return;
        try {
            await fetch(`/api/conversations/${id}`, { method: 'DELETE' });
            loadConversations();
        } catch(e) {}
    }

    async function newConversation() {
        try { await fetch('/api/conversations', { method: 'POST' }); } catch(e) {}
        chatMessages.innerHTML = `
            <div id="welcome-msg" class="text-center text-gray-400 dark:text-gray-500 py-16">
                <p class="text-2xl mb-2">&#x1F44B;</p>
                <p class="text-lg mb-1 text-gray-600 dark:text-gray-300">New conversation started.</p>
                <p class="text-sm">Type a message below.</p>
            </div>`;
        chatState = 'idle';
        setInputEnabled(true);
        loadConversations();
    }

    // --- SSE Connection ---
    function connectSSE() {
        if (eventSource) eventSource.close();
        eventSource = new EventSource('/chat/stream');
        eventSource.onmessage = function(e) {
            try { handleStreamEvent(JSON.parse(e.data)); } catch(err) {}
        };
        eventSource.onerror = function() {
            setTimeout(connectSSE, 3000);
        };
    }

    function handleStreamEvent(evt) {
        switch (evt.type) {
            case 'connected': break;
            case 'thinking':
                if (chatState === 'idle' || chatState === 'done') {
                    addThinkingIndicator();
                    chatState = 'thinking';
                }
                break;
            case 'token':
                if (chatState === 'thinking') {
                    removeThinkingIndicator();
                    currentBotDiv = createBotMessageDiv();
                    accumulatedContent = '';
                    chatState = 'streaming';
                }
                if (chatState === 'streaming' && currentBotDiv) {
                    accumulatedContent += evt.content;
                    renderBotContent(currentBotDiv, accumulatedContent);
                    scrollToBottom();
                }
                break;
            case 'tool_start':
                if (evt.tool) addToolBadge(evt.tool, evt.tool_id, true);
                break;
            case 'tool_end':
                if (evt.tool_id) completeToolBadge(evt.tool_id);
                break;
            case 'done':
                removeThinkingIndicator();
                if (chatState === 'streaming' && currentBotDiv && evt.content) {
                    renderBotContent(currentBotDiv, evt.content);
                } else if (evt.content && chatState !== 'streaming') {
                    addBotMessage(evt.content);
                }
                chatState = 'done';
                setInputEnabled(true);
                currentBotDiv = null;
                accumulatedContent = '';
                activeTools.clear();
                loadConversations(); // refresh sidebar
                break;
            case 'message':
                removeThinkingIndicator();
                if (evt.content) addBotMessage(evt.content);
                chatState = 'done';
                setInputEnabled(true);
                loadConversations();
                break;
            case 'error':
                removeThinkingIndicator();
                addErrorMessage(evt.content || 'Unknown error', true);
                chatState = 'done';
                setInputEnabled(true);
                break;
        }
    }

    // --- Helpers ---
    function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
    function scrollToBottom() { chatMessages.scrollTop = chatMessages.scrollHeight; }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 160) + 'px'; }
    function handleKeyDown(event) {
        if (event.key === 'Enter' && !event.shiftKey && !event.metaKey && !event.ctrlKey) {
            event.preventDefault();
            document.getElementById('chat-form').requestSubmit();
        }
    }

    if (typeof marked !== 'undefined') {
        marked.setOptions({
            highlight: function(code, lang) {
                if (typeof hljs !== 'undefined' && lang && hljs.getLanguage(lang)) {
                    try { return hljs.highlight(code, { language: lang }).value; } catch(e) {}
                }
                if (typeof hljs !== 'undefined') {
                    try { return hljs.highlightAuto(code).value; } catch(e) {}
                }
                return code;
            },
            breaks: true, gfm: true
        });
    }

    function renderMarkdown(text) {
        if (typeof marked !== 'undefined' && marked.parse) {
            try { return marked.parse(text); } catch(e) {}
        }
        return escapeHtml(text).replace(/\n/g, '<br>');
    }

    // --- Message rendering ---
    function addUserMessage(text) {
        const w = document.getElementById('welcome-msg'); if (w) w.remove();
        const div = document.createElement('div');
        div.className = 'msg-user max-w-4xl mx-auto';
        div.innerHTML = `<div class="flex justify-end"><div class="bg-blue-500 text-white rounded-2xl rounded-br-md px-4 py-2 max-w-[75%] shadow-sm"><p class="whitespace-pre-wrap">${escapeHtml(text)}</p></div></div>`;
        chatMessages.appendChild(div);
        scrollToBottom();
    }

    function createBotMessageDiv() {
        const w = document.getElementById('welcome-msg'); if (w) w.remove();
        const div = document.createElement('div');
        div.className = 'msg-bot max-w-4xl mx-auto';
        div.innerHTML = `<div class="flex justify-start"><div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-2 max-w-[75%] shadow-sm"><div class="tool-badges mb-1 flex flex-wrap gap-1"></div><div class="prose prose-sm dark:prose-invert max-w-none bot-content"></div></div></div>`;
        chatMessages.appendChild(div);
        return div;
    }

    function renderBotContent(div, text) {
        const el = div.querySelector('.bot-content');
        if (el) el.innerHTML = renderMarkdown(text);
    }

    function addBotMessage(text) {
        removeThinkingIndicator();
        const div = createBotMessageDiv();
        renderBotContent(div, text);
        scrollToBottom();
    }

    function addToolBadge(toolName, toolID, running) {
        let target = currentBotDiv;
        if (!target) {
            removeThinkingIndicator();
            target = createBotMessageDiv();
            currentBotDiv = target;
            chatState = 'streaming';
            accumulatedContent = '';
        }
        const badges = target.querySelector('.tool-badges');
        if (!badges) return;
        const badge = document.createElement('span');
        badge.className = 'tool-badge bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 border border-blue-200 dark:border-blue-700';
        badge.setAttribute('data-tool-id', toolID);
        badge.innerHTML = `<span class="tool-spinner"></span> ${escapeHtml(toolName)}`;
        badges.appendChild(badge);
        activeTools.set(toolID, badge);
        scrollToBottom();
    }

    function completeToolBadge(toolID) {
        const badge = activeTools.get(toolID);
        if (badge) {
            badge.className = 'tool-badge bg-green-50 dark:bg-green-900/30 text-green-700 dark:text-green-300 border border-green-200 dark:border-green-700';
            const s = badge.querySelector('.tool-spinner');
            if (s) s.outerHTML = '<span>&#x2713;</span>';
            activeTools.delete(toolID);
        }
    }

    function addThinkingIndicator() {
        removeThinkingIndicator();
        const div = document.createElement('div');
        div.id = 'thinking-indicator';
        div.className = 'msg-bot max-w-4xl mx-auto';
        div.innerHTML = `<div class="flex justify-start"><div class="bg-gray-100 dark:bg-gray-700 rounded-2xl rounded-bl-md px-4 py-3 shadow-sm"><div class="flex items-center space-x-1.5"><div class="thinking-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="thinking-dot w-2 h-2 bg-gray-400 rounded-full"></div><div class="thinking-dot w-2 h-2 bg-gray-400 rounded-full"></div></div></div></div>`;
        chatMessages.appendChild(div);
        scrollToBottom();
    }

    function removeThinkingIndicator() { const el = document.getElementById('thinking-indicator'); if (el) el.remove(); }

    function addErrorMessage(text, showRetry) {
        removeThinkingIndicator();
        const div = document.createElement('div');
        const retryBtn = showRetry ? '<button type="button" onclick="retrySend()" class="mt-2 text-sm font-medium text-blue-600 dark:text-blue-400 hover:underline">Thử lại</button>' : '';
        div.className = 'msg-bot max-w-4xl mx-auto';
        div.innerHTML = '<div class="flex justify-start"><div class="bg-red-50 dark:bg-red-900/30 border border-red-200 dark:border-red-700 rounded-2xl rounded-bl-md px-4 py-2 max-w-[75%] shadow-sm"><p class="text-red-600 dark:text-red-400 text-sm">' + escapeHtml(text) + '</p>' + retryBtn + '</div></div>';
        chatMessages.appendChild(div);
        scrollToBottom();
    }

    function setInputEnabled(enabled) {
        messageInput.disabled = !enabled;
        sendBtn.disabled = !enabled;
        if (enabled) messageInput.focus();
    }

    // --- Send handler ---
    async function handleSend(event) {
        event.preventDefault();
        const text = messageInput.value.trim();
        if (!text || chatState === 'thinking' || chatState === 'streaming') return false;

        lastUserMessageForRetry = text;
        addUserMessage(text);
        messageInput.value = '';
        messageInput.style.height = 'auto';
        var fileInputEl = document.getElementById('file-input');
        if (fileInputEl) fileInputEl.value = '';
        setInputEnabled(false);
        chatState = 'thinking';
        addThinkingIndicator();

        try {
            const formData = new FormData();
            formData.append('message', text);
            formData.append('stream', 'true');
            const fileInput = document.getElementById('file-input');
            if (fileInput && fileInput.files && fileInput.files.length > 0) {
                for (let i = 0; i < fileInput.files.length; i++) formData.append('files', fileInput.files[i]);
            }
            const resp = await fetch('/chat/send', { method: 'POST', body: formData });
            if (!resp.ok) {
                const data = await resp.json().catch(() => ({}));
                addErrorMessage(data.error || 'Request failed: ' + resp.statusText, true);
                chatState = 'done';
                setInputEnabled(true);
            }
        } catch (err) {
            addErrorMessage('Network error: ' + err.message, true);
            chatState = 'done';
            setInputEnabled(true);
        }
        return false;
    }

    function retrySend() {
        if (!lastUserMessageForRetry || chatState === 'thinking' || chatState === 'streaming') return;
        setInputEnabled(false);
        chatState = 'thinking';
        addThinkingIndicator();
        const formData = new FormData();
        formData.append('message', lastUserMessageForRetry);
        formData.append('stream', 'true');
        const fileInput = document.getElementById('file-input');
        if (fileInput && fileInput.files && fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) formData.append('files', fileInput.files[i]);
        }
        fetch('/chat/send', { method: 'POST', body: formData }).then(function(resp) {
            if (!resp.ok) {
                resp.json().catch(() => ({})).then(function(data) {
                    addErrorMessage(data.error || 'Request failed: ' + resp.statusText, true);
                    chatState = 'done';
                    setInputEnabled(true);
                });
            }
        }).catch(function(err) {
            addErrorMessage('Network error: ' + err.message, true);
            chatState = 'done';
            setInputEnabled(true);
        });
    }

    // Init
    connectSSE();
    loadConversations();
    </script>
</body>
</html>
